name: ðŸ“ Update Repository Metadata

on:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'README.md'
      - '.github/workflows/update-repo-metadata.yml'
  workflow_dispatch:

jobs:
  update-metadata:
    name: ðŸ”„ Update Repository Details
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“– Extract Package Info
        id: package
        run: |
          DESCRIPTION=$(node -p "require('./package.json').description")
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "ðŸ“ Description: $DESCRIPTION"

      - name: ðŸ·ï¸ Update Repository Details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.NEWTH_GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            // Repository metadata
            const repoData = {
              owner,
              repo,
              description: "${{ steps.package.outputs.description }}",
              homepage: "https://template.newth.ai",
              topics: [
                "react",
                "typescript", 
                "vite",
                "widget-template",
                "shadcn-ui",
                "tailwindcss",
                "embeddable-widgets",
                "phosphor-icons",
                "template",
                "boilerplate",
                "starter-kit"
              ],
              has_issues: true,
              has_discussions: true,
              has_wiki: true,
              has_projects: true,
              allow_squash_merge: true,
              allow_merge_commit: false,
              allow_rebase_merge: true,
              delete_branch_on_merge: true,
              allow_update_branch: true,
              use_squash_pr_title_as_default: true
            };

            try {
              console.log('ðŸ”„ Updating repository metadata...');
              await github.rest.repos.update(repoData);
              console.log('âœ… Repository metadata updated successfully!');
              
              console.log('ðŸ·ï¸ Updated details:');
              console.log(`   Description: ${repoData.description}`);
              console.log(`   Homepage: ${repoData.homepage}`);
              console.log(`   Topics: ${repoData.topics.join(', ')}`);
              
            } catch (error) {
              console.error('âŒ Failed to update repository metadata:', error);
              core.setFailed(`Failed to update repository: ${error.message}`);
            }

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ“ Repository Metadata Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully updated repository details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Updated Fields:" >> $GITHUB_STEP_SUMMARY
          echo "- **Description**: ${{ steps.package.outputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Website**: https://template.newth.ai" >> $GITHUB_STEP_SUMMARY
          echo "- **Topics**: react, typescript, vite, widget-template, shadcn-ui, tailwindcss, embeddable-widgets, phosphor-icons, template, boilerplate, starter-kit" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Settings**: Optimized for template usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Features Enabled:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ› Issues (for bug reports)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¬ Discussions (for community Q&A)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“– Wiki (for documentation)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Projects (for roadmap)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”€ Smart merge settings" >> $GITHUB_STEP_SUMMARY
